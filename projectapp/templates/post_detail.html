{% extends 'base.html' %}
{% block navbar %}
    {% include 'header.html' %}
{% endblock %}
{% block content %}
<style>
   .review-container {
    width: 500px;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.facebook-comment-form textarea {
    width: 100%;
    border-radius: 20px;
    border: 1px solid #ccc;
    padding: 12px 16px;
    resize: none;
    font-size: 14px;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
}

.facebook-comment-form textarea:focus {
    border-color: #1877f2; /* Facebook blue */
}

.attachments {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
}

.attach-btn {
    display: inline-block;
    padding: 8px 12px;
    border-radius: 20px;
    background: #f0f2f5;
    cursor: pointer;
    font-weight: 500;
    color: #1877f2;
    position: relative;
}

.attach-btn input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.selected-files {
    margin-top: 5px;
    font-size: 13px;
    color: #555;
}

.btn-submit {
    margin-top: 10px;
    background-color: #1877f2;
    color: white;
    border: none;
    border-radius: 20px;
    padding: 8px 16px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s;
}

.btn-submit:hover {
    background-color: #155db2;
}
.star-rating span {
    font-size: 2rem;
    cursor: pointer;
    color: lightgray;
    transition: color 0.2s;
}

.star-rating span.hover,
.star-rating span.selected {
    color: gold;
}
 .review-container {
      background: white;
      margin-top: 60px;
      padding: 30px;
      width: 500px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      resize: vertical;
      font-size: 15px;
      font-family: inherit;
    }

    .file-upload-wrapper {
      position: relative;
      margin-top: 20px;
      padding: 20px;
      border: 2px dashed #aaa;
      border-radius: 8px;
      text-align: center;
      background: #fdfdfd;
      transition: border 0.3s ease, background 0.3s ease;
    }

    .file-upload-wrapper:hover {
      border-color: #007bff;
      background: #f0f8ff;
    }

    .file-upload-wrapper input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .upload-label {
      font-weight: 500;
      color: #007bff;
      pointer-events: none;
    }

    .selected-files {
      margin-top: 10px;
      font-size: 14px;
      color: #555;
      text-align: left;
    }

    .preview-images {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .preview-images img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

</style>
<section class="d-flex justify-content-center align-items-start" style="min-height: 100vh; padding-top: 50px; padding-bottom: 50px; background-color: #f8f9fa;">
    <div style="max-width: 800px; width: 100%;">
        {% if post.image %}
        <img src="{{ post.image.url }}" alt="{{ post.title }}" style="object-fit: cover; height: 300px;">
        {% endif %}
        <div class=" p-4">
            <h2 class="fw-bold text-center">{{ post.title }}</h2>
            <p class="text-muted mb-2 small text-center">
                Category: <span class="fw-medium">{{ post.get_category_display }}</span> |
                Posted on {{ post.created_at|date:"M j, Y" }}
            </p>

            <p class=" text-center">{{ post.content }}</p>

            {% if post.estimated_price %}
            <p class="fw-semibold text-center">Estimated Price: <span class="text-success">₱{{ post.estimated_price }}</span></p>
            {% endif %}

            <div id="map" class="rounded-3 my-3" style="height: 300px;"></div>

            <div class="d-flex justify-content-center align-items-center gap-2 mt-3">
                <span onclick="toggleCollection({{ post.id }}, this)" style="cursor:pointer;">
                    {% if is_saved %}
                        <svg class="saved-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24">
                            <path fill="#000" d="M7.5 3.75a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-14a2 2 0 0 0-2-2z"/>
                        </svg>
                    {% else %}
                        <svg class="unsaved-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24">
                            <path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/>
                        </svg>
                    {% endif %}
                </span>
                <span class="text-muted small">Click to save/remove</span>
            </div>
        </div>
        <form id="ratingForm">
    {% csrf_token %}
    <div id="starRating" class="star-rating">
        <span data-value="1">★</span>
        <span data-value="2">★</span>
        <span data-value="3">★</span>
        <span data-value="4">★</span>
        <span data-value="5">★</span>
        <h3 id="outputText">Rating is: {{ user_rating }}/5</h3>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const stars = document.querySelectorAll('#starRating span');
    const outputText = document.getElementById('outputText');
    const postId = {{ post.id }};
    let selectedRating = {{ user_rating|default:0 }};

    function highlightStars(rating) {
        stars.forEach(star => {
            star.classList.toggle('hover', parseInt(star.dataset.value) <= rating);
        });
    }

    highlightStars(selectedRating);

    stars.forEach(star => {
        const value = parseInt(star.dataset.value);

        star.addEventListener('mouseover', () => highlightStars(value));
        star.addEventListener('mouseout', () => highlightStars(selectedRating));

        star.addEventListener('click', () => {
            selectedRating = value;
            highlightStars(selectedRating);
            outputText.innerText = `Rating is: ${selectedRating}/5`;
            submitRating(value);
        });
    });

    function submitRating(value) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

       fetch(`/post/${postId}/rate/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ rating_value: value }),  // <-- this is correct
        })
        .then(res => res.text())
        .then(text => {
            try {
                const data = JSON.parse(text);
                if (!data.success) console.error(data.error_message);
                else console.log('Rating saved', data.average_rating);
            } catch (err) {
                console.error('Expected JSON but got HTML. Likely a server error or login redirect.');
                console.log(text); // This is the HTML error page
            }
        })
        .catch(err => console.error('Error submitting rating:', err));
    }
});
</script>   
        <div class="post">
            {% if post.average_rating %}
                <p id="average-rating">Average Rating: {{ average_rating|floatformat:1 }} / 5 </p>
            {% else %}
                <p id="average-rating">No ratings yet.</p>
            {% endif %}
        </div>
        <form method="post" enctype="multipart/form-data"
            class="review-form"
            action="{% url 'add_review' post.id %}">
            {% csrf_token %}
            
            <!-- Comment -->
            <div class="form-group mb-3">
                {{ review_form.comment.label_tag }}
                {{ review_form.comment }}
                {% if review_form.comment.errors %}
                    <div class="text-danger small">{{ review_form.comment.errors }}</div>
                {% endif %}
            </div>

            <!-- Attach images -->
            <div class="form-group mb-3">
                {{ review_form.images.label_tag }}
                {{ review_form.images }}
                {% if review_form.images.errors %}
                    <div class="text-danger small">{{ review_form.images.errors }}</div>
                {% endif %}
            </div>

            <button type="submit" class="btn btn-primary">Post Review</button>
        </form>
    </div>
    
</section>


<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>


    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function toggleCollection(postId, iconWrapper) {
        const csrftoken = getCookie('csrftoken');
        fetch(`/toggle_collection/${postId}/`, {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
        })
        .then(res => res.json())
        .then(data => {
            const filledSvg = `<svg class="saved-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24"><path fill="#000" d="M7.5 3.75a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-14a2 2 0 0 0-2-2z"/></svg>`;
            const outlineSvg = `<svg class="unsaved-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg>`;

            iconWrapper.innerHTML = data.added ? filledSvg : outlineSvg;
        })
        .catch(err => console.error(err));
    }

    document.addEventListener("DOMContentLoaded", function () {
        const lat = {{ post.latitude }};
        const lng = {{ post.longitude }};
        const map = L.map('map').setView([lat, lng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        L.marker([lat, lng])
            .addTo(map)
            .bindPopup(`<b>{{ post.title }}</b><br>{{ post.get_category_display }}`)
            .openPopup();
    });

    const fileInput = document.getElementById("id_images");
    fileInput.addEventListener("change", function() {
        const files = Array.from(fileInput.files).map(f => f.name).join(", ");
        if(files) {
            alert("Selected files: " + files);
        }
    });
    
</script>
{% endblock %}

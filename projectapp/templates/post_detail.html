{% extends 'base.html' %}
{% block navbar %}
    {% include 'header.html' %}
{% endblock %}
{% block content %}
<style>
.star-rating span {
    font-size: 2rem;
    cursor: pointer;
    color: lightgray;
    transition: color 0.2s;
}

.star-rating span.hover,
.star-rating span.selected {
    color: gold;
}
</style>
<section class="d-flex justify-content-center align-items-start" style="min-height: 100vh; padding-top: 50px; padding-bottom: 50px; background-color: #f8f9fa;">
    <div style="max-width: 800px; width: 100%;">
        {% if post.image %}
        <img src="{{ post.image.url }}" alt="{{ post.title }}" style="object-fit: cover; height: 300px;">
        {% endif %}
        <div class=" p-4">
            <h2 class="fw-bold text-center">{{ post.title }}</h2>
            <p class="text-muted mb-2 small text-center">
                Category: <span class="fw-medium">{{ post.get_category_display }}</span> |
                Posted on {{ post.created_at|date:"M j, Y" }}
            </p>

            <p class=" text-center">{{ post.content }}</p>

            {% if post.estimated_price %}
            <p class="fw-semibold text-center">Estimated Price: <span class="text-success">₱{{ post.estimated_price }}</span></p>
            {% endif %}

            <div id="map" class="rounded-3 my-3" style="height: 300px;"></div>

            <div class="d-flex justify-content-center align-items-center gap-2 mt-3">
                <span onclick="toggleCollection({{ post.id }}, this)" style="cursor:pointer;">
                    {% if is_saved %}
                        <svg class="saved-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24">
                            <path fill="#000" d="M7.5 3.75a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-14a2 2 0 0 0-2-2z"/>
                        </svg>
                    {% else %}
                        <svg class="unsaved-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24">
                            <path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/>
                        </svg>
                    {% endif %}
                </span>
                <span class="text-muted small">Click to save/remove</span>
            </div>
        </div>
        <form id="ratingForm">
            {% csrf_token %}
            <div id="starRating" class="star-rating">
                <span data-value="1">★</span>
                <span data-value="2">★</span>
                <span data-value="3">★</span>
                <span data-value="4">★</span>
                <span data-value="5">★</span>
                <h3 id="outputText">Rating is: 0/5</h3>
            </div>
        </form>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const stars = document.querySelectorAll('#starRating span');
                const outputText = document.getElementById('outputText');
                const postId = {{ post.id }}; 
                let selectedRating = {{ user_rating }};

                function highlightStars(rating) {
                    stars.forEach(star => {
                        if (parseInt(star.dataset.value) <= rating) {
                            star.classList.add('hover');
                        } else {
                            star.classList.remove('hover');
                        }
                    });
                }

                highlightStars(selectedRating);
                stars.forEach(star => {
                    const value = parseInt(star.dataset.value);

                    star.addEventListener('mouseover', () => highlightStars(value));
                    star.addEventListener('mouseout', () => highlightStars(selectedRating));

                    star.addEventListener('click', () => {
                        selectedRating = value;
                        highlightStars(selectedRating);
                        outputText.innerText = `Rating is: ${selectedRating}/5`;
                        submitRating(value);
                    });
                });

                function submitRating(value) {
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    fetch(`/post/${postId}/rate/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify({ rating_value: value }),
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (!data.success) console.error(data.error_message);
                    })
                    .catch(err => console.error(err));
                }
            });
        </script>
        <div class="post">
            {% if post.average_rating %}
                <p id="average-rating">Average Rating: {{ post.average_rating|floatformat:1 }} / 5 </p>
            {% else %}
                <p id="average-rating">No ratings yet.</p>
            {% endif %}
        </div>

            <!-- Review Submission Form -->
        <div class="mt-4 border-top pt-4">
            <h5 class="fw-bold">Add a Review</h5>
            {% if user.is_authenticated %}
            <form method="POST" enctype="multipart/form-data" action="{% url 'add_review' post.id %}">
                {% csrf_token %}
                <div class="d-flex align-items-center gap-2 mb-2">
                    <label for="id_rating" class="mb-0">Rating:</label>
                    {{ form.rating }}
                </div>
                <div class="mb-2">
                    {{ form.comment }}
                </div>
                <div class="mb-3">
                    {{ form.image }}
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Submit Review</button>
            </form>
            {% else %}
            <p class="text-muted">Please <a href="{% url 'login' %}">login</a> to add a review.</p>
            {% endif %}
        </div>

        <!-- Reviews Display -->
        <div class="mt-4 border-top pt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold mb-0">Reviews & Comments</h4>
                <select id="sortReviews" class="form-select form-select-sm w-auto">
                    <option value="newest">Newest</option>
                    <option value="highest">Highest Rated</option>
                    <option value="lowest">Lowest Rated</option>
                </select>
            </div>
            <div id="reviewsContainer">
                {% include 'partials/review_list.html' %}
            </div>
        </div>
    </div>
    
</section>


<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleCollection(postId, iconWrapper) {
    const csrftoken = getCookie('csrftoken');
    fetch(`/toggle_collection/${postId}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken},
    })
    .then(res => res.json())
    .then(data => {
        const filledSvg = `<svg class="saved-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24"><path fill="#000" d="M7.5 3.75a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-14a2 2 0 0 0-2-2z"/></svg>`;
        const outlineSvg = `<svg class="unsaved-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg>`;

        iconWrapper.innerHTML = data.added ? filledSvg : outlineSvg;
    })
    .catch(err => console.error(err));
}

document.addEventListener("DOMContentLoaded", function () {
    const lat = {{ post.latitude }};
    const lng = {{ post.longitude }};
    const map = L.map('map').setView([lat, lng], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    L.marker([lat, lng])
        .addTo(map)
        .bindPopup(`<b>{{ post.title }}</b><br>{{ post.get_category_display }}`)
        .openPopup();
});
</script>
{% endblock %}

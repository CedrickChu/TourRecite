{% extends 'base.html' %}
{% block navbar %}
    {% include 'header.html' %}
{% endblock %}
{% block content %}
{% load static%}
{% load custom_filters %}

<style>

.star-rating span {
    font-size: 20px;
}
.panel-body {
    padding: 25px 20px;
    box-shadow: #555 0 2px 4px 0;
}


.media-block .media-left {
    display: block;
    float: left
}

.media-block .media-right {
    float: right
}

.media-block .media-body {
    display: block;
    overflow: hidden;
    width: auto
}

.middle .media-left,
.middle .media-right,
.middle .media-body {
    vertical-align: middle
}

.thumbnail {
    border-radius: 0;
    border-color: #e9e9e9
}

.tag.tag-sm, .btn-group-sm>.tag {
    padding: 5px 10px;
}

.tag:not(.label) {
    background-color: #fff;
    padding: 6px 12px;
    border-radius: 2px;
    border: 1px solid #cdd6e1;
    font-size: 12px;
    line-height: 1.42857;
    vertical-align: middle;
    -webkit-transition: all .15s;
    transition: all .15s;
}
.text-muted, a.text-muted:hover, a.text-muted:focus {
    color: #acacac;
}
.text-sm {
    font-size: 0.9em;
}
.text-5x, .text-4x, .text-5x, .text-2x, .text-lg, .text-sm, .text-xs {
    line-height: 1.25;
}

.btn-trans {
    background-color: transparent;
    border-color: transparent;
    color: #929292;
}

.btn-icon {
    padding-left: 9px;
    padding-right: 9px;
}

.btn-sm, .btn-group-sm>.btn, .btn-icon.btn-sm {
    padding: 5px 10px !important;
}

.mar-top {
    margin-top: 15px;
}
   /* Container for all reviews */
.card.comments-card {
    background: #d6d6d6ff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    padding: 20px;
    margin-bottom: 30px;
}

/* Title */
.card.comments-card .title {
    font-weight: 600;
    font-size: 1.2rem;
    margin-bottom: 15px;
    display: block;
}

/* Single comment container */
.comment-container {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 12px;
    position: relative;
}

/* User info */
.user {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.user-pic {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 10px;
}

.user-info span {
    font-weight: 600;
    display: block;
}

.user-info p {
    font-size: 0.8rem;
    color: #707277;
    margin: 0;
}

/* Comment text */
.comment-content {
    font-size: 0.95rem;
    line-height: 1.4;
    margin-bottom: 8px;
}

/* Images in comment */
.comment-container img {
    border-radius: 8px;
    max-width: 100px;
    margin-right: 8px;
    margin-bottom: 8px;
    object-fit: cover;
}

/* Reaction bar */
.comment-react {
    display: flex;
    align-items: center;
    gap: 8px;
}

.comment-react button {
    background: #f0f2f5;
    border: none;
    padding: 4px 8px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
}

.comment-react button:hover {
    background: #e4e6eb;
}

/* Reply box */
.text-box {
    display: flex;
    align-items: center;
    margin-top: 10px;
}

.text-box textarea {
    width: 100%;
    border-radius: 20px;
    border: 1px solid #ccc;
    padding: 8px 12px;
    resize: none;
    font-size: 14px;
    outline: none;
    margin-right: 8px;
}

.text-box textarea:focus {
    border-color: #1877f2;
}

/* Send button inside reply */
.text-box .send {
    background-color: #1877f2;
    color: white;
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.text-box .send:hover {
    background-color: #155db2;
}
   .review-container {
    width: 500px;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.facebook-comment-form textarea {
    width: 100%;
    border-radius: 20px;
    border: 1px solid #ccc;
    padding: 12px 16px;
    resize: none;
    font-size: 14px;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
}

.facebook-comment-form textarea:focus {
    border-color: #1877f2; /* Facebook blue */
}

.attachments {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
}

.attach-btn {
    display: inline-block;
    padding: 8px 12px;
    border-radius: 20px;
    background: #f0f2f5;
    cursor: pointer;
    font-weight: 500;
    color: #1877f2;
    position: relative;
}

.attach-btn input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.selected-files {
    margin-top: 5px;
    font-size: 13px;
    color: #555;
}

.btn-submit {
    margin-top: 10px;
    background-color: #1877f2;
    color: white;
    border: none;
    border-radius: 20px;
    padding: 8px 16px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s;
}

.btn-submit:hover {
    background-color: #155db2;
}
.star-rating span { 
    font-size: 2rem;
    cursor: pointer;
    color: lightgray;
    transition: color 0.2s;
}

.star-rating span.hover,
.star-rating span.selected {
    color: gold;
}
 .review-container {
      background: white;
      margin-top: 60px;
      padding: 30px;
      width: 500px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      resize: vertical;
      font-size: 15px;
      font-family: inherit;
    }

    .file-upload-wrapper {
      position: relative;
      margin-top: 20px;
      padding: 20px;
      border: 2px dashed #aaa;
      border-radius: 8px;
      text-align: center;
      background: #fdfdfd;
      transition: border 0.3s ease, background 0.3s ease;
    }

    .file-upload-wrapper:hover {
      border-color: #007bff;
      background: #f0f8ff;
    }

    .file-upload-wrapper input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .upload-label {
      font-weight: 500;
      color: #007bff;
      pointer-events: none;
    }

    .selected-files {
      margin-top: 10px;
      font-size: 14px;
      color: #555;
      text-align: left;
    }

    .preview-images {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .preview-images img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

</style>
<section class="d-flex justify-content-center align-items-start" style="padding-top: 50px; padding-bottom: 10px; background-color: #f8f9fa;">
    <div style="max-width: 800px; width: 100%;">
        {% if post.image %}
        <img src="{{ post.image.url }}" alt="{{ post.title }}" class="w-100 rounded" style="object-fit: cover; height: 300px;">
        {% endif %}

        <div class="p-4">
        <h2 class="fw-bold text-center">{{ post.title }}</h2>
        <p class="text-muted mb-2 small text-center">
            Category: <span class="fw-medium">{{ post.get_category_display }}</span> |
            Posted on {{ post.created_at|date:"M j, Y" }}
        </p>

        <p class="text-center">{{ post.content }}</p>

        {% if post.estimated_price %}
        <p class="fw-semibold text-center">
            Estimated Price: <span class="text-success">‚Ç±{{ post.estimated_price }}</span>
        </p>
        {% endif %}

        <div id="map" class="rounded-3 my-3" style="height: 300px;"></div>

        <div class="d-flex justify-content-center align-items-center gap-2 mt-3">
            <span onclick="toggleCollection({{ post.id }}, this)" style="cursor:pointer;">
            {% if is_saved %}
            <svg class="saved-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24">
                <path fill="#000" d="M7.5 3.75a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-14a2 2 0 0 0-2-2z"/>
            </svg>
            {% else %}
            <svg class="unsaved-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24">
                <path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/>
            </svg>
            {% endif %}
            </span>
            <span class="text-muted small">Click to save/remove</span>
        </div>
        </div>

        <!-- ‚≠ê Rating Section -->
        <div class="text-center mt-4">
        <form id="ratingForm">
            {% csrf_token %}
            <div id="starRating" class="star-rating mb-2">
            <span data-value="1">‚òÖ</span>
            <span data-value="2">‚òÖ</span>
            <span data-value="3">‚òÖ</span>
            <span data-value="4">‚òÖ</span>
            <span data-value="5">‚òÖ</span>
            </div>
            <h5 id="outputText" class="mb-2">Rating is: {{ user_rating }}/5</h5>
        </form>

        <div class="post mb-4">
            {% if average_rating %}
                <p id="average-rating">
                    Average Rating: {{ average_rating|floatformat:1 }} / 5 
                    ({{ rating_count }} Review{{ rating_count|pluralize }})
                </p>
            {% else %}
                <p id="average-rating">No ratings yet.</p>
            {% endif %}
        </div>
        </div>


        <!-- üìù Review Form -->
        <div class="p-4 mb-5 shadow-sm">
            <h5 class="text-center mb-3">Leave a Review</h5>
            <div class="d-flex justify-content-between align-items-center mb-3">
  <!-- Filter dropdown -->
                <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Filter by: {{ filter_option|capfirst }}
                </button>
                <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                    <li><a class="dropdown-item" href="?filter=all&sort={{ sort_option }}">All</a></li>
                    <li><a class="dropdown-item" href="?filter=with_photos&sort={{ sort_option }}">With Photos</a></li>
                </ul>
                </div>

                <!-- Sort dropdown -->
                <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Sort by: 
                    {% if sort_option == 'highest' %}Highest Review{% elif sort_option == 'lowest' %}Lowest Review{% else %}New{% endif %}
                </button>
                <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                    <li><a class="dropdown-item" href="?filter={{ filter_option }}&sort=new">New</a></li>
                    <li><a class="dropdown-item" href="?filter={{ filter_option }}&sort=highest">Highest Review</a></li>
                    <li><a class="dropdown-item" href="?filter={{ filter_option }}&sort=lowest">Lowest Review</a></li>
                </ul>
                </div>
                </div>
            <form method="post" enctype="multipart/form-data" class="review-form" action="{% url 'add_review' post.id %}">
                {% csrf_token %}
                <div class="panel">
                    <div class="panel-body">
                        <!-- Comment textarea -->
                        <div class="form-group mb-2">
                            {{ review_form.comment }}
                            {% if review_form.comment.errors %}
                                <div class="text-danger small">{{ review_form.comment.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Hidden file input -->
                        <div class="form-group mb-2 d-none">
                            {{ review_form.images }}
                            {% if review_form.images.errors %}
                                <div class="text-danger small">{{ review_form.images.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Buttons: attach + submit -->
                        <div class="mar-top clearfix">
                            <!-- Paperclip icon -->
                             <button class="btn btn-sm btn-primary pull-right" type="submit"><i class="fa fa-pencil fa-fw"></i> Share</button>
                            <a href="#" id="attachBtn" class="btn btn-trans btn-icon bi bi-paperclip add-tooltip"
                            title="Attach images"></a>

                
                        </div>

                        <!-- Optional: preview filenames -->
                        <div id="filePreview" class="mt-2 small text-muted"></div>
                    </div>
                </div>
            </form>
                <div class="panel">
                <div class="panel-body">
                    <div class="p-3">
                        <h5 class="mt-4">Reviews</h5>

                        <div class="review-list">
                        {% for review in reviews %}
                            <div class="review-card d-flex align-items-start mb-3 p-3 border rounded">

                            <!-- Heart / Like -->
                            <div class="me-3 text-center">
                                <button class="like-btn" onclick="toggleLike({{ review.id }})" style="background:none; border:none; cursor:pointer;">
                                <span id="heart-{{ review.id }}">
                                    {% if review.id in user_liked_review_ids %}
                                    ‚ù§Ô∏è
                                    {% else %}
                                    ü§ç
                                    {% endif %}
                                </span>
                                </button>
                                <div id="like-count-{{ review.id }}">{{ review.likes_count }}</div>
                            </div>

                            <!-- User info + comment -->
                            <div>
                                <div class="d-flex align-items-center mb-1">
                                <!-- Profile image -->
                                {% if review.user.profile_image %}
                                    <img src="{{ review.user.profile_image.url }}" class="rounded-circle me-2" style="width:40px; height:40px; object-fit:cover;">
                                {% else %}
                                    <img src="{% static 'images/default.png' %}" class="rounded-circle me-2" style="width:40px; height:40px; object-fit:cover;">
                                {% endif %}

                                <div>
                                    <strong>{{ review.user.username }}</strong><br>
                                    <small class="text-muted">{{ review.created_at|date:"l, F jS \a\\t g:i a" }}</small>
                                </div>
                                </div>
                                <!-- Rating stars -->
                                {% if review.rating %}
                                <div class="star-rating mb-2">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= review.rating %}
                                            <span class="text-warning">‚òÖ</span>
                                        {% else %}
                                            <span class="text-secondary">‚òÖ</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <p style="margin-left: 50px;">{{ review.comment }}</p>

                                {% if review.images.all %}
                                <div class="d-flex flex-wrap" style="margin-left:50px;">
                                    {% for media in review.images.all %}
                                        {% with file_url=media.image.url %}
                                            {% if file_url|is_media:"video" %}
                                                <video controls class="me-2 mb-2" style="max-width:200px; border-radius:8px;">
                                                    <source src="{{ file_url }}">
                                                </video>

                                            {% elif file_url|is_media:"audio" %}
                                                <audio controls class="me-2 mb-2" style="width:200px;">
                                                    <source src="{{ file_url }}">
                                                </audio>

                                            {% elif file_url|is_media:"image" %}
                                                <img src="{{ file_url }}" class="me-2 mb-2" style="max-width:120px; border-radius:8px;">

                                            {% else %}
                                                <a href="{{ file_url }}" target="_blank" class="me-2 mb-2 d-block">
                                                    <i class="bi bi-file-earmark-text"></i> Download File
                                                </a>
                                            {% endif %}
                                        {% endwith %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            </div>
                        {% empty %}
                            <p>No reviews yet. Be the first to comment!</p>
                        {% endfor %}
                        </div>
                    </div>
                </div>
        </div>
    </div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const attachBtn = document.getElementById("attachBtn");
        const fileInput = document.querySelector('input[type="file"][name="images"]');
        const preview = document.getElementById("filePreview");

        attachBtn.addEventListener("click", function(e) {
            e.preventDefault();
            fileInput.click(); 
        });
        fileInput.addEventListener("change", function() {
            if (fileInput.files.length > 0) {
                const files = Array.from(fileInput.files).map(f => f.name).join(', ');
                preview.textContent = "üìé " + files;
            } else {
                preview.textContent = "";
            }
        });
    });
    function toggleLike(reviewId) {
        fetch(`/review/${reviewId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                const heart = document.getElementById(`heart-${reviewId}`);
                const count = document.getElementById(`like-count-${reviewId}`);
                heart.textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
                count.textContent = data.likes_count;
            }
        });
    }
    document.addEventListener('DOMContentLoaded', function() {
      const stars = document.querySelectorAll('#starRating span');
      const outputText = document.getElementById('outputText');
      const postId = {{ post.id }};
      let selectedRating = {{ user_rating|default:0 }};

      function highlightStars(rating) {
        stars.forEach(star => {
          star.classList.toggle('hover', parseInt(star.dataset.value) <= rating);
        });
      }

      highlightStars(selectedRating);

      stars.forEach(star => {
        const value = parseInt(star.dataset.value);
        star.addEventListener('mouseover', () => highlightStars(value));
        star.addEventListener('mouseout', () => highlightStars(selectedRating));
        star.addEventListener('click', () => {
          selectedRating = value;
          highlightStars(selectedRating);
          outputText.innerText = `Rating is: ${selectedRating}/5`;
          submitRating(value);
        });
      });

      function submitRating(value) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        fetch(`/post/${postId}/rate/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
          body: JSON.stringify({ rating_value: value }),
        })
          .then(res => res.text())
          .then(text => {
            try {
              const data = JSON.parse(text);
              if (!data.success) console.error(data.error_message);
              else console.log('Rating saved', data.average_rating);
            } catch (err) {
              console.error('Expected JSON but got HTML. Likely a server error or login redirect.');
              console.log(text);
            }
          })
          .catch(err => console.error('Error submitting rating:', err));
      }
    });
  </script>
 
</section>


<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>


    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function toggleCollection(postId, iconWrapper) {
        const csrftoken = getCookie('csrftoken');
        fetch(`/toggle_collection/${postId}/`, {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
        })
        .then(res => res.json())
        .then(data => {
            const filledSvg = `<svg class="saved-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24"><path fill="#000" d="M7.5 3.75a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-14a2 2 0 0 0-2-2z"/></svg>`;
            const outlineSvg = `<svg class="unsaved-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg>`;

            iconWrapper.innerHTML = data.added ? filledSvg : outlineSvg;
        })
        .catch(err => console.error(err));
    }

    document.addEventListener("DOMContentLoaded", function () {
        const lat = {{ post.latitude }};
        const lng = {{ post.longitude }};
        const map = L.map('map').setView([lat, lng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        L.marker([lat, lng])
            .addTo(map)
            .bindPopup(`<b>{{ post.title }}</b><br>{{ post.get_category_display }}`)
            .openPopup();
    });

    const fileInput = document.getElementById("id_images");
        fileInput.addEventListener("change", function() {
            const files = Array.from(fileInput.files).map(f => f.name).join(", ");
            if(files) {
                alert("Selected files: " + files);
            }
        });
        document.querySelector('.review-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        fetch(form.action, {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const list = document.getElementById("review-list");
                const div = document.createElement("div");
                div.classList.add("border", "p-2", "mb-2", "rounded");
                div.innerHTML = `<strong>${data.user}</strong><p>${data.comment}</p><small>${data.created_at}</small>`;
                list.prepend(div);
                form.reset();
            } else {
                console.log(data.errors);
            }
        });
    });
    
</script>
{% endblock %}

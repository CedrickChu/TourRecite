{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}TourRecite{% endblock %}

{% block navbar %}
    {% include 'header.html' %}
{% endblock %}

{% block content %}
<style>
    .fixed-sidebar {
  position: fixed;
  right: 5%;
  top: 80px;
  width: 320px; 
  max-height: calc(100vh - 100px);
  overflow-y: auto;
  background: white;
}
.add-collection:hover {
  transform: scale(1.5);
  transition: 0.2s;
  fill: #0b5ed7 !important;
}

@media (max-width: 992px) {
  .fixed-sidebar {
    position: static;
    width: 100%;
    max-height: none;
    overflow: visible;
  }
}

</style>
<section class="container" style="margin-top: 100px;">
    <!-- Create Button -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        {% if user.is_authenticated and user.is_superuser %}
            <a href="{% url 'create_post' %}" class="btn btn-dark d-flex align-items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                    <path fill="none" d="M0 0h24v24H0z"></path>
                    <path fill-rule="evenodd"
                        d="M12 3.75a.75.75 0 0 1 .75.75v6.75h6.75a.75.75 0 0 1 0 1.5h-6.75v6.75a.75.75 0 0 1-1.5 0v-6.75H4.5a.75.75 0 0 1 0-1.5h6.75V4.5a.75.75 0 0 1 .75-.75Z"
                        clip-rule="evenodd" />
                </svg>
                Create
            </a>
        {% endif %}
    </div>
     <form method="GET" action="{% url 'index_view' %}" class="d-flex" role="search" style="margin-bottom: 20px;width: 60%;"><br>
            <input class="form-control me-2" type="search" name="q" placeholder="Search posts..." value="{{ request.GET.q|default:'' }}">
            <button class="btn btn-outline-dark" type="submit">Search</button>
        </form>

    <div class="row g-4">
        <!-- Left Column: Posts Feed -->
        <div class="col-lg-8">
            <h2 class="fw-bold mb-3">Recommended Picks</h2>

            {% if recommended_posts %}
                {% for post in recommended_posts %}
                    <div class="mb-5 pb-4 border-bottom d-flex justify-content-between align-items-start post-card">
                        <div class="flex-grow-1 pe-3">
                            <!-- Author + Category -->
                            <div class="text-muted small mb-2">
                                In 
                                <span class="fw-semibold text-dark">
                                    {{ post.get_category_display }}
                                </span>
                                &nbsp;•&nbsp;
                            </div>

                            <!-- Title -->
                            <a href="{% url 'post_detail' post_id=post.id %}" class="text-dark text-decoration-none">
                                <h4 class="fw-bold mb-2">{{ post.title }}</h4>
                            </a>

                            <!-- Description -->
                            <p class="text-muted mb-3" style="font-size: 0.95rem;">
                                {% if post.content|wordcount > 25 %}
                                    {{ post.content|truncatewords:25 }}…
                                    <a href="{% url 'post_detail' post_id=post.id %}" class="text-decoration-none">Continue reading</a>
                                {% else %}
                                    {{ post.content }}
                                {% endif %}
                            </p>
                            {% if post.tags.all %}
                                <div class="mb-3">
                                    {% for tag in post.tags.all %}
                                        <span class="badge rounded-pill bg-light text-dark border me-1 mb-1" style="font-size:0.8rem;">
                                            #{{ tag.name }}
                                        </span>
                                    {% endfor %}
                                </div>
                            {% endif %}

                            <!-- Bottom icons -->
                            <div class="d-flex align-items-center gap-3 text-muted small">
                                <span>{{ post.created_at|date:"M j" }}</span>
                                <span onclick="toggleCollection({{ post.id }}, this)" 
                                    style="cursor:pointer;" 
                                    data-post-id="{{ post.id }}">
                                    {% if post.id in saved_posts %}
                                        <!-- Saved icon -->
                                        <svg class="saved-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                            <path fill="#000" d="M7.5 3.75a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-14a2 2 0 0 0-2-2z"/>
                                        </svg>
                                    {% else %}
                                        <!-- Unsaved icon -->
                                        <svg class="unsaved-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                            <path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/>
                                        </svg>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        <!-- Image (Right side) -->
                        {% if post.image %}
                        <div class="post-thumb flex-shrink-0">
                            <a href="{% url 'post_detail' post_id=post.id %}">
                                <img src="{{ post.image.url }}"  alt="{{ post.title }}"
                                    style="width:140px;height:100px;object-fit:cover;">
                            </a>
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No recommendations yet. Try saving or tagging your interests!</p>
            {% endif %}



        </div>
        <!-- Right Column: Sidebar -->
        <div class="col-lg-4">
            <aside id="travelList" class="fixed-sidebar">
                <div class="fixed">
                    <!-- Traveler’s Choice -->
                    <div class="list-group mt-4">
                        <h6 class="fw-bold mb-3">Traveler’s Choice</h6>

                        {% if travelers_page %}
                            {% for post in travelers_page %}

                                    {% if post.image %}
                                        <img src="{{ post.image.url }}" 
                                            alt="{{ post.title }}" 
                                            class="card-img-top rounded-top"
                                            style="height:130px; width:100%; object-fit:cover;">
                                    {% endif %}

                                        <h6 class="fw-bold mb-1 text-truncate">
                                            <a href="{% url 'post_detail' post_id=post.id %}" 
                                            class="text-dark text-decoration-none">
                                                {{ post.title }}
                                            </a>
                                        </h6>

                                        <p class="text-muted small mb-2">
                                            ⭐ {{ post.rating }} / 5 &nbsp;•&nbsp;
                                            {{ post.get_category_display }}
                                        </p>

                                        <p class="text-muted small mb-2" style="font-size: 0.85rem;">
                                            {{ post.content|truncatewords:18 }}
                                        </p>

                                        <a href="{% url 'post_detail' post_id=post.id %}" 
                                        class="btn btn-sm btn-dark rounded-pill">
                                            Read More
                                        </a>

                                        {% if post.tags.exists %}
                                            <div class="mt-2">
                                                {% for tag in post.tags.all %}
                                                    <span class="badge bg-light text-dark border rounded-pill me-1 small">
                                                        #{{ tag.name }}
                                                    </span>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <br><br><br>
                            {% endfor %}
                            
                            <!-- Pagination -->
                            {% if travelers_page.has_other_pages %}
                                <nav aria-label="Traveler’s Choice Pagination">
                                    <ul class="pagination pagination-sm justify-content-center mt-3">
                                        {% if travelers_page.has_previous %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ travelers_page.previous_page_number }}">Previous</a>
                                            </li>
                                        {% endif %}

                                        {% for num in travelers_page.paginator.page_range %}
                                            <li class="page-item {% if travelers_page.number == num %}active{% endif %}">
                                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                            </li>
                                        {% endfor %}

                                        {% if travelers_page.has_next %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ travelers_page.next_page_number }}">Next</a>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No top-rated posts yet.</p>
                        {% endif %}
                        
                    </div>
                    
                    <!-- Recommended Tags -->
                    <h6 class="fw-bold mt-4 mb-3">Recommended</h6>
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        <span class="badge bg-light text-dark border">Technology</span>
                        <span class="badge bg-light text-dark border">Writing</span>
                        <span class="badge bg-light text-dark border">Self Improvement</span>
                        <span class="badge bg-light text-dark border">Relationships</span>
                        <span class="badge bg-light text-dark border">Cryptocurrency</span>
                        <span class="badge bg-light text-dark border">Politics</span>
                    </div>

                    <!-- Your Travel List -->
                    {% if user.is_authenticated %}
                        <aside class="sticky-sidebar">
                            <h6 class="fw-bold mt-4 mb-3">Your Travel List</h6>
                            {% with mylist=user.collections.first %}
                                {% if mylist and mylist.posts.count %}
                                    <ul class="list-group list-group-flush">
                                        {% for post in mylist.posts.all %}
                                            <li class="list-group-item border-0 px-0">
                                                <a href="{% url 'post_detail' post_id=post.id %}" class="text-decoration-none text-dark">
                                                    {{ post.title }}
                                                </a>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-muted">No saved posts yet.</p>
                                {% endif %}
                            {% endwith %}
                        </aside>
                    {% endif %}
                </div>
            </aside>

        </div>
    </div>
</section>

<script>
    function confirmDelete(postId) {
        if (confirm("Are you sure you want to delete this post?")) {
            const csrftoken = getCookie('csrftoken');
            fetch(`/delete_post/${postId}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrftoken }
            }).then(response => {
                if (response.ok) window.location.reload();
            });
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            document.cookie.split(';').forEach(cookie => {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                }
            });
        }
        return cookieValue;
    }
    function toggleCollection(postId, iconWrapper) {
    console.log("Clicked post:", postId);

    const csrftoken = getCookie('csrftoken');
    fetch(`/toggle_collection/${postId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
        },
    })
    .then(response => response.json())
    .then(data => {
        console.log("Server responded with:", data);

        const filledSvg = `
            <svg class="saved-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path fill="#000" d="M7.5 3.75a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-14a2 2 0 0 0-2-2z"/>
            </svg>
        `;

        const outlineSvg = `
            <svg class="unsaved-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/>
            </svg>
        `;

        if (data.added === true) {
            alert("✅ Post saved to your collection!");
            iconWrapper.innerHTML = filledSvg;
        } else {
            alert("❌ Post removed from your collection.");
            iconWrapper.innerHTML = outlineSvg;
        }
    })
    .catch(error => {
        console.error("Error toggling collection:", error);
    });
}
</script>
{% endblock %}
